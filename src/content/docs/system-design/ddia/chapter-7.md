---
title: Chapter 7 - 事务
description: 数据密集型应用 - 读书笔记
---

在数据存储的环境中，会有许多可能出错的情况。为了系统高可靠的目标，事务技术一直是简化这些问题的首选机制。事务将应用程序的多个读、写操作捆绑在一起成为一个逻辑操作单元。即事务中的所有读写是一个执行的整体，整个事务要么成功（提交）、要么失败（中止或回滚）。如果失败，应用程序可以安全重试。

## 深入理解事务

通常意义上的事务针对的是多个对象，将多个操作聚合为一个逻辑执行单元

### ACID 的含义

事务所提供的安全保证即大家所熟知的 ACID，分别代表原子性（Atomicity），一致性（Consistency），隔离性（Isolation），与持久性（Durability）

* 原子性：在出错时中止事务，并将部分完成的写入全部丢弃
* 一致性：对数据有特定的预期状态，任何数据更改必须满足这些状态约束（或者恒等条件）
* 隔离性：并发执行的多个事务相互隔离，不能互相交叉（可串行化）
* 持久性：一旦事务提交成功，即使存在硬件故障或数据库崩溃，事务所写入的任何数据也不会消失

不符合 ACID 标准的系统有时被冠以 BASE，即基本可用性（Basically Available），软状态（Soft state），和最终一致性（Eventual consistency）

### 单对象与多对象事务操作

ACID 中的原子性和隔离性主要针对客户端在同一事务中包含多个写操作时，数据库所提供的保证。这些定义假定在一个事务中会修改多个对象（如行、文档、记录等），这种多对象事务目的通常是为了在多个数据对象之间保持同步。

原子性和隔离性也同样适用于单个对象的更新，因此存储引擎几乎必备的设计就是在单节点、单个对象层面上提供原子性和隔离性。例如，在宕机时基于日志恢复来实现原子性，对每个对象采用加锁的方式来实现隔离。这些但对象操作可以有效防止多个客户端并发修改同一对象时的更新丢失问题。

许多分布式数据库不支持多对象事务，主要是因为当出现跨分区时，多对象事务非常难以正确实现，同时在高可用或者极致性能的场景下也会带来很多负面影响。